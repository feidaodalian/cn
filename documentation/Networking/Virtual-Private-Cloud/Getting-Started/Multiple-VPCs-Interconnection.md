# 多VPC互通

## 操作场景

同一地域内多个VPC需要互联互通时，可基于边界网关创建与不同VPC连接的边界网关接口，简化配置部署。同一地域内三个以下VPC需互通时，尽量通过创建[VPC对等连接](../Introduction/Features/VPC-Peering-Features.md)实现VPC互连，时延小、配置简单；但当需要互通的VPC数量较多时，建议通过边界网关实现互连。


> 多VPC互联通前，应规划好所有需互通的VPC内网段，尽量保证VPC内的网段不会重叠。如果网段重叠实在不可避免，需要合理配置VPC与边界网关的路由传播范围，保证同一路由表内网段不重叠。

## 前提条件及限制

- 确保您已经[注册京东云账号](https://user.jdcloud.com/register?returnUrl=https%3A%2F%2Fwww.jdcloud.com%2F)，并实现[实名认证](https://docs.jdcloud.com/cn/real-name-verification/introduction)；
- 确保您已经创建了两个VPC，VPC下划分了子网；
- 同一个VPC和同一个边界网关只能创建一个VPC接口，目前VPC接口仅支持同地域的VPC与边界网关互联，同一个VPC可与多个边界网关创建不同的VPC接口，另外一个边界网关支持与多个不同VPC创建不同的VPC接口


## 操作步骤

第一步：[创建边界网关](multiple-vpcs-interconnection#user-content-1)

第二步：[创建边界网关接口](multiple-vpcs-interconnection#user-content-2)

第三步：[配置VPC内的路由表](multiple-vpcs-interconnection#user-content-3)

第四步：[配置边界网关上的路由表](multiple-vpcs-interconnection#user-content-4)


> 以下操作步骤均须在同一地域下进行。


#### **第一步：创建边界网关**

<div id="user-content-1"> </div>

步骤1：登录京东云控制台，进入控制台导航页面；

步骤2：在控制台左侧导航栏，选择【混合云连接】-> 【边界网关】->选择【边界网关】，进入边界网关列表页；

步骤3：选择资源部署地域，点击【创建】按钮进入创建边界网关弹窗；

步骤4：完善信息，点击【确定】完成边界网关创建。


> 新建的边界网关不会与任何VPC或者通道连接、需要配置创建边界网关接口或者专线通道等建立连接通道。


**第二步：创建边界网关的VPC接口**

<div id="user-content-2"> </div>

步骤1：登录京东云控制台，进入控制台导航页面；

步骤2：在控制台左侧导航栏，选择【混合云连接】-> 【边界网关】->选择【VPC接口】，进入VPC接口列表页；

步骤3：点击【创建】，配置VPC接口，以便边界网关与选定的VPC建立连接、进行互通，详见控制台页面；

主要配置项如下：

- 接口名称：边界网关与VPC连接的接口名称；

- 边界网关：选择需要互联的边界网关（第一步中创建的边界网关），边界网关对内与VPC进行通信，同时可作为京东云侧和客户IDC侧运行BGP的终结点；
  
- VPC：选择需要互联的VPC；
  
- 传播的VPC网段：
  
    **VPC全部网段**：边界网关的路由全自动引入方式，表示系统将自动在边界网关的路由表内添加访问VPC全网段的路由表项。全网段包括VPC当前全部子网的网段，并且将根据VPC子网后续的变化自动更新边界网关的路由表项——如后续新增子网时、系统将自动将到达新子网的路由添加到边界网关路由表，删除子网时、自动同步删除边界网关对应的路由表项
    
    **指定子网网段**：边界网关的路由半自动引入方式，表示系统将自动在边界网关的路由表内添加访问VPC内已指定网段的路由。这种方式下，边界网关的路由将不会自动适配VPC内指定子网以外的调整，如新增或者删除指定范围外的子网都不会引起边界网关的路由变化；但若是指定范围内的子网变化，如删除范围内子网、需要先删除VPC接口的传播子网段。
    
    **不传播网段**：边界网关的路由全手动配置方式，表示系统不会自动在边界网关路由表内添加任何访问VPC的路由，需要用户在BGW路由表内手动配置静态路由。

步骤4：配置完上述信息后，单击“确定”，在VPC接口列表中，该通道的状态为配置中。

步骤5：边界网关接口完成配置后，通道状态变为可用，此时即可使用该连接进行数据传输。


> 当边界网关VPC内子网网段与其他通道连接网段存在重叠时，创建VPC接口时可选“指定子网网段”、并选相互不重叠的子网网段，避免重叠VPC子网网段传播到边界网关路由表，以满足某些VPC地址存在重叠的应用场景需求

相同操作，为多个VPC创建VPC接口，VPC接口的配置项中，选择同一个边界网关，VPC接口创建完成后，进行配置路由。

#### **第三步：配置VPC内的路由表**

<div id="user-content-3"> </div>

步骤1：登录京东云控制台，进入控制台导航页面；

步骤2：在控制台左侧导航栏，选择网络 -> 【私有网络】-> 【路由表】，配置各个VPC中需要通过边界网关与其余VPC进行通信的子网所关联的路由表。

步骤3：配置路由表，有两种方式：静态路由方式，路由自动传播方式。

 **静态路由方式**
  
  若计划完全自定义路由，就采用静态路由配置方式。定位需要互联子网的路由表，进入路由表详情页，选择路由策略Tab，进入路由策略页面，点击【编辑】按钮，然后点击【新增一条】新增路由规则，其中【目的端】值为您期望被访问的VPC网段，下一跳类型选择边界网关，下一跳选择所需互联边界网关的VPC接口，如需要访问多个VPC，则需配置多条对应的路由策略。

  **路由自动传播方式**
  
  若想简化网络配置过程，利用京东云平台提供的从边界网关自动传播路由到VPC路由表的能力，则采用路由自动传播方式。定位需要互联子网的路由表，进入路由表详情页，选择路由传播Tab，进入路由传播页面，点击【添加】按钮，输入对应的信息，一个VPC可以同时与多个边界网关建立路由传播关系。
  
- 边界网关：选择向VPC传播路由的源边界网关

- 路由传播范围：指从边界网关传播到VPC的路由前缀CIDR地址范围，支持输入多个CIDR范围，多个之间以英文逗号分隔。配置传播路由后，将自动将所选边界网关中该网段及其子网段的路由传播到此路由表。支持配置传播0.0.0.0/0路由，此时将传播所选边界网关中的全部路由。

>  配置生效后，系统将从边界网关有效路由表中选择路由前缀在传播范围内的路由规则（包括静态和动态路由），自动添加VPC路由表内，下一跳类型为边界网关、下一跳指向“路由传播”配置中指定的边界网关名称、路由类型为传播。传播类型路由不可编辑。

#### **第四步：配置边界网关上的路由表**

<div id="user-content-4"> </div>

步骤1：登录京东云控制台。

步骤2：点击左侧导航栏，选择“专线服务 -> 边界网关”，进入用于承载专线连接网络互通的边界网关的详情页面。

步骤3：配置路由表，设定通往每个VPC的路由表项，有两种方式：静态路由方式，路由自动传播方式。

**静态路由方式**：

当创建边界网关与VPC互联的VPC接口时，如果传播VPC网段选择“不传播网段”时，需要手动配置到达多个VPC的路由，即逐项配置通往所有需要互通的VPC侧的静态路由。配置通往VPC侧的静态路由，选择“路由表->静态路由表”，点击“编辑”，路由规则目的端为VPC内的网段，下一跳类型选择VPC接口，下一跳选择要进行通信的具体VPC接口信息。

**路由自动传播方式**：

当创建边界网关与VPC互联的VPC接口时，如果传播VPC网段选择“VPC全部网段”或者“指定子网网段”时，即为路由自动传播方式。边界网关路由表会依据配置的子网范围，在动态路由表自动添加或者删除到达相关子网的路由表项，目的网段为VPC子网网段、下一跳类型选择VPC接口、下一跳为连接指定VPC和边界网关的VPC接口、路由类型为传播。动态传播路由将与静态路由表的路由统一进行优先级比对，高优先级路由会自动加入有效路由表内。用户可直接在路由表内查看动态传播路由、不需要用户配置，用户也不可以修改、删除动态传播路由。

## 相关参考

- [边界网关简介](https://docs.jdcloud.com/cn/direct-connection/border-gateway-features)
- [创建边界网关](https://docs.jdcloud.com/cn/direct-connection/border-gateway-configuration)       
- [创建VPC接口](https://docs.jdcloud.com/cn/direct-connection/vpc-attachment-configuration)
- [边界网关路由管理](https://docs.jdcloud.com/cn/direct-connection/border-gateway-route-configuration)
- [VPC路由管理](../Operation-Guide/Route-Table-Configuration.md)




